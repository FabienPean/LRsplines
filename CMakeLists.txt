PROJECT(LRSpline)

CMAKE_MINIMUM_REQUIRED(VERSION 2.6)

# Required defines (well, PROFILE_LEVEL is not actually required, but...)
SET(CMAKE_CXX_FLAGS "-Dreal=double -DepsZ=1.0e-12 -DPROFILE_LEVEL=3")
SET(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -DINDEX_CHECK=2")
IF(VERBOSE_DEBUG GREATER 0)
  SET(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -DSP_DEBUG=${VERBOSE_DEBUG}")
ENDIF(VERBOSE_DEBUG GREATER 0)

ENABLE_LANGUAGE(CXX)
IF(CMAKE_CXX_COMPILER MATCHES icpc)
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DUSE_MKL")
ELSE(CMAKE_CXX_COMPILER MATCHES icpc)
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DUSE_CBLAS")
ENDIF(CMAKE_CXX_COMPILER MATCHES icpc)

ENABLE_TESTING()

# Add local modules
set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH}
                      ${CMAKE_SOURCE_DIR}/cmake/Modules)

# Required packages
FIND_PACKAGE(Boost REQUIRED)
FIND_PACKAGE(GoTools REQUIRED)

# Optional packages

# Required libraries
SET(DEPLIBS ${GoTools_LIBRARIES} ${Boost_LIBRARIES})

# Required include directories
SET(INCLUDES
  ${Boost_INCLUDE_DIRS}
  ${GoTools_INCLUDE_DIRS}
  ${PROJECT_SOURCE_DIR}/include
)

INCLUDE_DIRECTORIES(${INCLUDES})

SET(EXECUTABLE_OUTPUT_PATH bin)
SET(LIBRARY_OUTPUT_PATH lib)

IF(NOT WIN32)
  # Emit position-independent code, suitable for dynamic linking
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -fPIC")
  # Enable all warnings
  SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wno-parentheses")
ENDIF(NOT WIN32)

# Make the LRSpline library
FILE(GLOB_RECURSE LRSPLINE_SRCS ${PROJECT_SOURCE_DIR}/src/*.cpp)
ADD_LIBRARY(LRSpline ${LRSPLINE_SRCS})

# Make some Apps
FILE(GLOB_RECURSE Tensor_SRCS ${PROJECT_SOURCE_DIR}/Apps/TensorComparison.cpp)
ADD_EXECUTABLE(TensorComparison ${Tensor_SRCS})
TARGET_LINK_LIBRARIES(TensorComparison LRSpline ${DEPLIBS})

FILE(GLOB_RECURSE UnityPart_SRCS ${PROJECT_SOURCE_DIR}/Apps/PartitionOfUnityTest.cpp)
ADD_EXECUTABLE(PartitionOfUnityTest ${UnityPart_SRCS})
TARGET_LINK_LIBRARIES(PartitionOfUnityTest LRSpline ${DEPLIBS})

FILE(GLOB_RECURSE Refinement_SRCS ${PROJECT_SOURCE_DIR}/Apps/RefinementUnchanged.cpp)
ADD_EXECUTABLE(RefinementUnchanged ${Refinement_SRCS})
TARGET_LINK_LIBRARIES(RefinementUnchanged LRSpline ${DEPLIBS})

FILE(GLOB_RECURSE Stresstest_SRCS ${PROJECT_SOURCE_DIR}/Apps/StresstestRefinement.cpp)
ADD_EXECUTABLE(StresstestRefinement ${Stresstest_SRCS})
TARGET_LINK_LIBRARIES(StresstestRefinement LRSpline ${DEPLIBS})

FILE(GLOB_RECURSE ReadWrite_SRCS ${PROJECT_SOURCE_DIR}/Apps/TestReadWrite.cpp)
ADD_EXECUTABLE(TestReadWrite ${ReadWrite_SRCS})
TARGET_LINK_LIBRARIES(TestReadWrite LRSpline ${DEPLIBS})

# # Regression tests
# FILE(GLOB_RECURSE LINEL_TESTFILES "${PROJECT_SOURCE_DIR}/Apps/LinearElasticity/Test/*.reg")
# FOREACH(TESTFILE ${LINEL_TESTFILES})
#   ADD_TEST(${TESTFILE} ${PROJECT_SOURCE_DIR}/test/regtest.sh "${CMAKE_BINARY_DIR}/${EXECUTABLE_OUTPUT_PATH}/LinEl" "${TESTFILE}")
# ENDFOREACH()
# 
# FILE(GLOB_RECURSE POISSON_TESTFILES "${PROJECT_SOURCE_DIR}/Apps/Poisson/Test/*.reg")
# FOREACH(TESTFILE ${POISSON_TESTFILES})
#   ADD_TEST(${TESTFILE} ${PROJECT_SOURCE_DIR}/test/regtest.sh "${CMAKE_BINARY_DIR}/${EXECUTABLE_OUTPUT_PATH}/Poisson" "${TESTFILE}")
# ENDFOREACH()

IF(NOT LRSPLINE_INSTALL_PREFIX)
  SET(LRSPLINE_INSTALL_PREFIX $ENV{HOME})
ENDIF(NOT LRSPLINE_INSTALL_PREFIX)

# 'install' target
IF(WIN32)
  # TODO
ELSE(WIN32)
  # lib
  INSTALL(TARGETS LRSpline DESTINATION ${LRSPLINE_INSTALL_PREFIX}/lib)

  # headers
  FILE(GLOB_RECURSE LRSPLINE_HEADERS include/LRSpline/*.h)
  INSTALL(FILES ${LRSPLINE_HEADERS}
          DESTINATION ${LRSPLINE_INSTALL_PREFIX}/include/LRSpline)

  FILE(GLOB_RECURSE LOCAL_CMAKE_MODULES cmake/Modules/*.cmake)

  # cmake modules
  INSTALL(FILES ${LOCAL_CMAKE_MODULES} DESTINATION ${LRSPLINE_INSTALL_PREFIX}/cmake/Modules)
ENDIF(WIN32)
